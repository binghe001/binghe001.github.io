(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{379:function(t,s,a){"use strict";a.r(s);var n=a(8),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"《并发设计模式》第11章-保护性暂挂模式-使用保护性暂挂模式优化交易系统性能"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#《并发设计模式》第11章-保护性暂挂模式-使用保护性暂挂模式优化交易系统性能"}},[t._v("#")]),t._v(" 《并发设计模式》第11章-保护性暂挂模式-使用保护性暂挂模式优化交易系统性能")]),t._v(" "),s("p",[t._v("作者：冰河\n"),s("br"),t._v("星球："),s("a",{attrs:{href:"http://m6z.cn/6aeFbs",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://m6z.cn/6aeFbs"),s("OutboundLink")],1),t._v(" "),s("br"),t._v("博客："),s("a",{attrs:{href:"https://binghe.gitcode.host",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://binghe.gitcode.host"),s("OutboundLink")],1),t._v(" "),s("br"),t._v("文章汇总："),s("a",{attrs:{href:"https://binghe.gitcode.host/md/all/all.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://binghe.gitcode.host/md/all/all.html"),s("OutboundLink")],1),t._v(" "),s("br"),t._v("源码获取地址："),s("a",{attrs:{href:"https://t.zsxq.com/0dhvFs5oR",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://t.zsxq.com/0dhvFs5oR"),s("OutboundLink")],1)]),t._v(" "),s("blockquote",[s("p",[t._v("沉淀，成长，突破，帮助他人，成就自我。")])]),t._v(" "),s("ul",[s("li",[t._v("本章难度：★★☆☆☆")]),t._v(" "),s("li",[t._v("本章重点：掌握保护性暂挂模式的使用场景，理解保护性暂挂模式的核心原理与实现方式，并能够结合自身实际业务场景将保护性暂挂模式灵活应用到自身实际项目中。")])]),t._v(" "),s("p",[s("strong",[t._v("大家好，我是冰河~~")])]),t._v(" "),s("p",[t._v("在并发编程中，为了提升程序的并发度和性能，往往会将一个大的任务分解成多个小的子任务，并且将这些子任务交给多个线程执行，多个线程在执行子任务的过程中，会存在一个线程需要等待其他线程完成后才能继续执行的情况，而保护性暂挂模式就比较适合这种场景。")]),t._v(" "),s("h2",{attrs:{id:"一、故事背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、故事背景"}},[t._v("#")]),t._v(" 一、故事背景")]),t._v(" "),s("p",[t._v("老王看了小菜写的交易流程代码后，分析出小菜写的代码不只是性能问题，还存在加锁的线程安全性问题，并为小菜分不同的业务关系场景讲清楚了为何交易过程中会存在线程安全问题，也讲解了如何使用正确的方式加锁。同时，老王也为小菜讲解了如何进行锁优化，以及如何解决锁优化过程中产生的死锁问题。")]),t._v(" "),s("p",[t._v("对于小菜来说，学到了在多线程并发场景下，如何对锁进行优化，在某些场景下，为何会出现死锁，产生死锁的必要条件，以及如何预防死锁。")]),t._v(" "),s("p",[t._v("学完这些知识后，小菜就尝试去解决自己开发交易功能时，存在的线程安全问题，小菜采用的是破坏请求与保持条件的预防死锁方案，处理完后，再次找到老王，让其看看自己实现的代码还会不会存在其他问题。")]),t._v(" "),s("h2",{attrs:{id:"二、出乎意料"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、出乎意料"}},[t._v("#")]),t._v(" 二、出乎意料")]),t._v(" "),s("p",[t._v("小菜使用破坏请求与保持条件的预防死锁方案优化了自己实现的交易系统流程，这天来到公司后，发现老王已经坐在工位上正在处理工作。小菜走到自己的工位上，将电脑包放到办公桌上，便向老王说：“早啊，老大”。")]),t._v(" "),s("p",[t._v("老王抬头看到是小菜，便说了句：“之前讲的都明白了吧？交易的代码修改了吗？”。")]),t._v(" "),s("p",[t._v("小菜随即说到：“之前讲的都明白了，代码也已经优化完了，老大帮我看看还有啥问题，可以吗？”。")]),t._v(" "),s("p",[t._v("“可以”，老王随即离开座位走到了小菜的工位，看了看小菜写的代码后，说到：“使用破坏请求与保持条件的预防死锁的方案进行处理，可以是可以，只不过在并发量不是很大的时候，可以这样写，要是并发量上来就不能这么写了”。")]),t._v(" "),s("p",[t._v("小菜听后，一脸茫然，说到：“还有其他更优的方式吗？这个我就不太清楚了”。")]),t._v(" "),s("p",[t._v("老王笑了笑说到：“当然还有更优的实现方式，那就是使用保护性暂挂模式进行优化”。")]),t._v(" "),s("p",[t._v("“额，这个确实不知道，可以给我讲讲吗？”，小菜说道。")]),t._v(" "),s("p",[t._v("“可以，走，我们还是去会议室说”。")]),t._v(" "),s("p",[t._v("“好的”。")]),t._v(" "),s("p",[t._v("二人一起走进了会议室。")]),t._v(" "),s("h2",{attrs:{id:"三、性能问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、性能问题"}},[t._v("#")]),t._v(" 三、性能问题")]),t._v(" "),s("p",[t._v("使用破坏请求与保持条件的预防死锁的方案处理线程安全问题时，会存在性能问题，主要是因为在基于破坏请求与保持条件的预防死锁的方案处理线程安全问题时，会使用如下代码片段进行转账。")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//转账操作")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("transfer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TansferAccount")]),t._v(" target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Integer")]),t._v(" transferMoney"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//自旋申请转出账户和转入账户，直到成功")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("requester"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("applyResources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//循环体为空")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//对转出账户加锁")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("synchronized")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//对转入账户加锁")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("synchronized")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("balance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" transferMoney"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("balance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-=")]),t._v(" transferMoney"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                    target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("balance "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" transferMoney"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("   \n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("finally")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//最后释放账户资源")]),t._v("\n        requester"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("releaseResources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br"),s("span",{staticClass:"line-number"},[t._v("17")]),s("br"),s("span",{staticClass:"line-number"},[t._v("18")]),s("br"),s("span",{staticClass:"line-number"},[t._v("19")]),s("br"),s("span",{staticClass:"line-number"},[t._v("20")]),s("br"),s("span",{staticClass:"line-number"},[t._v("21")]),s("br"),s("span",{staticClass:"line-number"},[t._v("22")]),s("br"),s("span",{staticClass:"line-number"},[t._v("23")]),s("br")])]),s("p",[t._v("性能瓶颈会出现在如下代码片段。")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//自旋申请转出账户和转入账户，直到成功")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("requester"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("applyResources")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//循环体为空")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("这种方式就是死循环的方式来循环等待，直到一次全部获取到两个锁后，才进行后面的转账操作。")]),t._v(" "),s("p",[t._v("这种方式在并发量不大的情况下，可以接受，但是一旦并发量增大，获取锁的冲突增加的时候，这种方案就不适合了，因为在这种场景下，很有可能要循环成千上万次才能获得锁，非常消耗系统性能，在高并发大流量的业务场景下很显然不合适。")]),t._v(" "),s("p",[t._v("在这种场景下，最好的方案就是使用Guarded Suspension模式，也就是保护性暂挂模式，在这种高并发设计模式下，如果线程A获取不到所有的锁，就阻塞自己，进入“等待WAITING”状态。当线程A要求的所有条件都满足后，通知阻塞的线程A继续执行。")]),t._v(" "),s("h2",{attrs:{id:"四、保护性暂挂模式流程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、保护性暂挂模式流程"}},[t._v("#")]),t._v(" 四、保护性暂挂模式流程")]),t._v(" "),s("p",[t._v("基于保护性暂挂模式进行转账的流程如图11-1所示。")]),t._v(" "),s("h2",{attrs:{id:"查看全文"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看全文"}},[t._v("#")]),t._v(" 查看全文")]),t._v(" "),s("p",[t._v("加入"),s("a",{attrs:{href:"http://m6z.cn/6aeFbs",target:"_blank",rel:"noopener noreferrer"}},[t._v("冰河技术"),s("OutboundLink")],1),t._v("知识星球，解锁完整技术文章与完整代码")])])}),[],!1,null,null,null);s.default=e.exports}}]);