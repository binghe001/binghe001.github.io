(window.webpackJsonp=window.webpackJsonp||[]).push([[882],{1215:function(s,t,n){"use strict";n.r(t);var a=n(15),e=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"《分布式im系统》大后端平台-通用模型-第02节-用户session与全局异常捕获机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#《分布式im系统》大后端平台-通用模型-第02节-用户session与全局异常捕获机制"}},[s._v("#")]),s._v(" 《分布式IM系统》大后端平台-通用模型-第02节：用户Session与全局异常捕获机制")]),s._v(" "),t("p",[s._v("作者：冰河\n"),t("br"),s._v("星球："),t("a",{attrs:{href:"http://m6z.cn/6aeFbs",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://m6z.cn/6aeFbs"),t("OutboundLink")],1),s._v(" "),t("br"),s._v("博客："),t("a",{attrs:{href:"https://binghe.gitcode.host",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://binghe.gitcode.host"),t("OutboundLink")],1),s._v(" "),t("br"),s._v("文章汇总："),t("a",{attrs:{href:"https://binghe.gitcode.host/md/all/all.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://binghe.gitcode.host/md/all/all.html"),t("OutboundLink")],1),s._v(" "),t("br"),s._v("源码获取地址："),t("a",{attrs:{href:"https://t.zsxq.com/0dhvFs5oR",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://t.zsxq.com/0dhvFs5oR"),t("OutboundLink")],1),s._v(" "),t("br"),s._v("课程视频："),t("a",{attrs:{href:"https://t.zsxq.com/15w8khYq7",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://t.zsxq.com/15w8khYq7"),t("OutboundLink")],1)]),s._v(" "),t("blockquote",[t("p",[s._v("沉淀，成长，突破，帮助他人，成就自我。")])]),s._v(" "),t("ul",[t("li",[s._v("本节难度：★★☆☆☆")]),s._v(" "),t("li",[s._v("本节重点：对分布式IM即时通讯系统大后端平台的用户Session、全局异常捕获机制和通用返回模型数据进行设计和实现，掌握用户Session机制、全局异常捕获机制和通用返回模型数据的设计技巧，并能够将其灵活应用到自身实际项目中。")]),s._v(" "),t("li",[s._v("课程视频："),t("a",{attrs:{href:"https://t.zsxq.com/15w8khYq7",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://t.zsxq.com/15w8khYq7"),t("OutboundLink")],1)])]),s._v(" "),t("p",[t("strong",[s._v("大家好，我是冰河~~")])]),s._v(" "),t("p",[s._v("大后端平台并不是一个单体的应用，在设计上，我们会将其整体分为："),t("strong",[s._v("用户微服务、好友关系微服务、群组微服务、消息微服务")]),s._v("。但是，在正式实现每个微服务时，除了要设计和实现通用的领域层对象模型外，还需要统一设计和实现各个微服务都需要支持的Session机制、全局异常捕获机制和通用的数据响应机制。")]),s._v(" "),t("p",[t("strong",[s._v("注意：本节的代码结构与上一节的代码结构有所不同，从本节开始，分布式IM即时通讯系统会被正式拆分成四个微服务。")])]),s._v(" "),t("h2",{attrs:{id:"一、前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、前言"}},[s._v("#")]),s._v(" 一、前言")]),s._v(" "),t("p",[s._v("大后端平台是整个分布式IM即时通讯系统的核心服务之一，考虑到大后端平台是用户访问分布式IM即时通讯的直接入口。在某些场景下，会存在瞬时高并发大流量的现象。因此，我们不能将大后端平台设计成一个单体应用，以免后续出现整体上的性能瓶颈。")]),s._v(" "),t("p",[s._v("从业务角度划分，我们将分布式IM即时通讯系统的大后端平台整体分成：："),t("strong",[s._v("用户微服务、好友关系微服务、群组微服务、消息微服务")]),s._v("。各个微服务之间存在独立的业务，但彼此之间也会存在某些关联的交互逻辑。同时，各个微服务都需要实现用户Session机制、全局异常捕获机制和通用数据响应机制。")]),s._v(" "),t("h2",{attrs:{id:"二、本节诉求"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、本节诉求"}},[s._v("#")]),s._v(" 二、本节诉求")]),s._v(" "),t("p",[s._v("对大后端平台下的各个微服务通用的Session机制、全局异常捕获机制和通用数据响应机制进行设计和实现，掌握通用的Session机制、全局异常捕获机制和通用数据响应机制的代码编写技巧，并能够将其灵活应用到自身实际项目中。")]),s._v(" "),t("h2",{attrs:{id:"三、编码实现"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三、编码实现"}},[s._v("#")]),s._v(" 三、编码实现")]),s._v(" "),t("p",[s._v("本节的内容比较简单，我们可以直接编码来实现，为后续正式开发大后端平台的各个微服务做准备。")]),s._v(" "),t("h3",{attrs:{id:"_3-1-实现session编码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-实现session编码"}},[s._v("#")]),s._v(" 3.1 实现Session编码")]),s._v(" "),t("p",[s._v("对于大后端平台各个微服务的通用Session来说，在实现上也比较简单，具体实现步骤如下所示。")]),s._v(" "),t("p",[t("strong",[s._v("（1）实现UserSession类")])]),s._v(" "),t("p",[s._v("UserSession类是用户Session中的具体数据类。")]),s._v(" "),t("p",[s._v("源码详见：io.binghe.im.platform.common.session.UserSession。")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserSession")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IMSessionInfo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" userName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" nickName"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/***********省略其他代码***********/")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("可以看到，UserSession类实现了通用的Session信息类IMSessionInfo，并添加了用户名和用户昵称信息。")]),s._v(" "),t("p",[t("strong",[s._v("（2）实现SessionContext类")])]),s._v(" "),t("p",[s._v("SessionContext类是Session的上下文类，当用户通过大后端平台登录分布式IM即时通讯系统时，大后端平台会生成一个附加了用户Session信息数据的JWT Token返回给用户，后续用户访问系统时，会在请求头中带上JWT Token，业务网关会拦截用户的请求，解析出JWT Token中的Session数据，放到request请求的属性中，在后续的请求链路中，可直接从request属性中获取到用户的Session数据。SessionContext类就是我们封装的直接从request属性中获取Session数据的类。")]),s._v(" "),t("p",[s._v("源码详见：io.binghe.im.platform.common.session.SessionContext。")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SessionContext")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserSession")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 从请求上下文里获取Request对象")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServletRequestAttributes")]),s._v(" requestAttributes "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ServletRequestAttributes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cast")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("RequestContextHolder")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getRequestAttributes")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("HttpServletRequest")]),s._v(" request "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" requestAttributes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getRequest")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserSession")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" request"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getAttribute")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IMPlatformConstants")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SESSION")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])]),t("h2",{attrs:{id:"查看完整文章"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看完整文章"}},[s._v("#")]),s._v(" 查看完整文章")]),s._v(" "),t("p",[s._v("加入"),t("a",{attrs:{href:"http://m6z.cn/6aeFbs",target:"_blank",rel:"noopener noreferrer"}},[s._v("冰河技术"),t("OutboundLink")],1),s._v("知识星球，解锁完整技术文章与完整代码")])])}),[],!1,null,null,null);t.default=e.exports}}]);