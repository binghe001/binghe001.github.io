(window.webpackJsonp=window.webpackJsonp||[]).push([[788],{1125:function(t,s,a){"use strict";a.r(s);var e=a(15),r=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"《实战ai大模型》ai数字人应用-第01节-实践qemu-kvm-虚拟化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#《实战ai大模型》ai数字人应用-第01节-实践qemu-kvm-虚拟化"}},[t._v("#")]),t._v(" 《实战AI大模型》AI数字人应用-第01节：实践QEMU-KVM 虚拟化")]),t._v(" "),s("p",[t._v("作者：冰河\n"),s("br"),t._v("星球："),s("a",{attrs:{href:"http://m6z.cn/6aeFbs",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://m6z.cn/6aeFbs"),s("OutboundLink")],1),t._v(" "),s("br"),t._v("博客："),s("a",{attrs:{href:"https://binghe.gitcode.host",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://binghe.gitcode.host"),s("OutboundLink")],1),t._v(" "),s("br"),t._v("文章汇总："),s("a",{attrs:{href:"https://binghe.gitcode.host/md/all/all.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://binghe.gitcode.host/md/all/all.html"),s("OutboundLink")],1),t._v(" "),s("br"),t._v("源码获取地址："),s("a",{attrs:{href:"https://t.zsxq.com/0dhvFs5oR",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://t.zsxq.com/0dhvFs5oR"),s("OutboundLink")],1)]),t._v(" "),s("p",[s("strong",[t._v("大家好，我是冰河~~")])]),t._v(" "),s("p",[t._v("今天，带着大家在Ubuntu Server25.04上实践QEMU-KVM 虚拟化，开始今天的正题。")]),t._v(" "),s("h2",{attrs:{id:"一、案例背景与目标"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、案例背景与目标"}},[t._v("#")]),t._v(" 一、案例背景与目标")]),t._v(" "),s("h3",{attrs:{id:"_1-1-案例背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-案例背景"}},[t._v("#")]),t._v(" 1.1 案例背景")]),t._v(" "),s("p",[t._v("在企业的IT基础架构中，一个常见的现象是：许多承担着诸如Nginx代理等轻量级服务的Linux物理服务器，其CPU、内存等核心硬件资源的利用率长期处于低位。这本质上是一种资源闲置与资本浪费。为了充分“唤醒”这些沉睡的算力，将单台物理服务器转变为能够同时承载多个独立业务系统的资源池，引入服务器虚拟化技术成为关键。")]),t._v(" "),s("p",[t._v("KVM（基于内核的虚拟机）正是这样一个高效、成熟的解决方案。它允许我们在单一的物理主机上，创建并运行多个像Tomcat应用服务器这样的虚拟机实例。通过这种方式，我们可以将原本分散在不同低利用率主机上的服务整合起来，大幅提升硬件资源的整体使用效率，从而有效降低企业在基础设施上的投入和运维成本。")]),t._v(" "),s("h2",{attrs:{id:"二、kvm-虚拟化原理详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、kvm-虚拟化原理详解"}},[t._v("#")]),t._v(" 二、KVM 虚拟化原理详解")]),t._v(" "),s("h3",{attrs:{id:"_2-1-kvm-的核心构成"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-kvm-的核心构成"}},[t._v("#")]),t._v(" 2.1 KVM 的核心构成")]),t._v(" "),s("p",[t._v("我们通常所说的“KVM虚拟化”，在广义上是一个由两大核心组件协同工作的技术栈：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("KVM 内核模块")]),t._v("：这是技术的灵魂。它作为Linux内核的一部分，直接负责对物理服务器的处理器（CPU）和内存资源进行虚拟化抽象，为虚拟机的运行提供最底层的硬件模拟支持。")]),t._v(" "),s("li",[s("strong",[t._v("Qemu")]),t._v("：这是一个功能强大的“管家”。它是一个经过定制化修改的用户空间程序，主要负责处理虚拟机的输入输出（I/O）操作（如磁盘、网络），并为我们提供了管理虚拟机生命周期（创建、启动、监控等）的各种命令行工具。")])]),t._v(" "),s("p",[t._v("需要明确的是，Qemu本身就是一个完整的软件模拟器，可以独立创建虚拟机，但性能不佳。而KVM的创新之处在于，它“嵌入”Linux内核，借助处理器自身的虚拟化扩展指令（如Intel VT或AMD-V），将大部分繁重的模拟工作交给硬件高效执行，从而实现了接近原生物理机的性能、出色的安全性与稳定性。")]),t._v(" "),s("h3",{attrs:{id:"_2-2-kvm-运行模式的演进"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-kvm-运行模式的演进"}},[t._v("#")]),t._v(" 2.2 KVM 运行模式的演进")]),t._v(" "),s("p",[t._v("KVM 的引入，为传统的Linux系统增加了新的维度，形成了以下三种运行模式：")]),t._v(" "),s("h4",{attrs:{id:"_2-2-1-客户机模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-客户机模式"}},[t._v("#")]),t._v(" 2.2.1 客户机模式")]),t._v(" "),s("p",[t._v("这是虚拟机内部的操作系统（Guest OS）所处的世界。它本身又包含两个层面：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("客户机内核模式")]),t._v("：运行Guest OS的内核，管理其虚拟的硬件资源。")]),t._v(" "),s("li",[s("strong",[t._v("客户机用户模式")]),t._v("：运行Guest OS中的应用程序。")])]),t._v(" "),s("h4",{attrs:{id:"_2-2-2-宿主机模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-宿主机模式"}},[t._v("#")]),t._v(" 2.2.2 宿主机模式")]),t._v(" "),s("p",[t._v("这是物理服务器本身的操作系统（Host OS）的世界，也分为两个经典层面：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("宿主机内核模式")]),t._v("：运行Linux宿主机的内核，KVM内核模块就在此生效。")]),t._v(" "),s("li",[s("strong",[t._v("宿主机用户模式")]),t._v("：运行宿主机上的管理程序，例如Qemu进程就运行于此。")])]),t._v(" "),s("h3",{attrs:{id:"_2-3-kvm-的工作流程剖析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-kvm-的工作流程剖析"}},[t._v("#")]),t._v(" 2.3 KVM 的工作流程剖析")]),t._v(" "),s("p",[t._v("KVM 虚拟机的运行是一个精妙的、在三种模式间动态切换的过程：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("启动")]),t._v("：用户在宿主机上通过 "),s("code",[t._v("qemu-kvm")]),t._v(" 命令启动一台虚拟机。Qemu 进程在"),s("strong",[t._v("宿主机用户模式")]),t._v("下开始工作。")]),t._v(" "),s("li",[s("strong",[t._v("内核介入")]),t._v("：Qemu 通过特定的系统调用（ioctl）与运行在"),s("strong",[t._v("宿主机内核模式")]),t._v("的 KVM 模块通信。KVM 模块负责为这个虚拟机创建虚拟的CPU（vCPU）和内存空间。")]),t._v(" "),s("li",[s("strong",[t._v("投入运行")]),t._v("：KVM 模块通过特殊的CPU指令（如 Intel 的 "),s("code",[t._v("VMLAUNCH")]),t._v("）将物理CPU切换到"),s("strong",[t._v("客户机模式")]),t._v("，开始执行虚拟机内的Guest OS代码。")]),t._v(" "),s("li",[s("strong",[t._v("异常处理")]),t._v("：当虚拟机运行时需要执行特权操作（如访问真实硬件）、发生外部中断（如时钟中断）或触发缺页异常时，CPU会自动从"),s("strong",[t._v("客户机模式")]),t._v("退出，交还控制权给"),s("strong",[t._v("宿主机内核模式")]),t._v("的KVM模块。")]),t._v(" "),s("li",[s("strong",[t._v("I/O 代理")]),t._v("：如果退出的原因是虚拟机需要进行I/O操作（例如读写虚拟磁盘），KVM模块会将此请求转交给运行在"),s("strong",[t._v("宿主机用户模式")]),t._v("下的Qemu进程来处理。")]),t._v(" "),s("li",[s("strong",[t._v("周期循环")]),t._v("：Qemu 完成模拟的I/O操作后，再次通过KVM模块将CPU切换回"),s("strong",[t._v("客户机模式")]),t._v("，让Guest OS继续运行。")])]),t._v(" "),s("p",[t._v("这个“客户机模式执行 -> 退出到宿主机内核处理 -> 必要时委托给宿主机用户空间Qemu”的循环，构成了KVM虚拟机高效运行的基石。")]),t._v(" "),s("h2",{attrs:{id:"三、案例环境准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、案例环境准备"}},[t._v("#")]),t._v(" 三、案例环境准备")]),t._v(" "),s("p",[t._v("本案例使用的环境如下表所示：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("主机名")]),t._v(" "),s("th",[t._v("操作系统")]),t._v(" "),s("th",[t._v("IP 地址")]),t._v(" "),s("th",[t._v("主要软件")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("binghe001")]),t._v(" "),s("td",[t._v("CentOS 7.9 x86_64")]),t._v(" "),s("td",[t._v("192.168.10.108")]),t._v(" "),s("td",[t._v("KVM 虚拟机")])]),t._v(" "),s("tr",[s("td",[t._v("binghe002")]),t._v(" "),s("td",[t._v("CentOS 7.9 x86_64")]),t._v(" "),s("td",[t._v("192.168.10.109")]),t._v(" "),s("td",[t._v("-")])])])]),t._v(" "),s("h2",{attrs:{id:"四、kvm-虚拟化平台搭建"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#四、kvm-虚拟化平台搭建"}},[t._v("#")]),t._v(" 四、KVM 虚拟化平台搭建")]),t._v(" "),s("h3",{attrs:{id:"_4-1-准备-kvm-虚拟化环境"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-准备-kvm-虚拟化环境"}},[t._v("#")]),t._v(" 4.1 准备 KVM 虚拟化环境")]),t._v(" "),s("h4",{attrs:{id:"_4-1-1-yum-安装-kvm-相关软件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-yum-安装-kvm-相关软件"}},[t._v("#")]),t._v(" 4.1.1 YUM 安装 KVM 相关软件")]),t._v(" "),s("p",[t._v("在 CentOS 系统中，可以通过 YUM 方便地安装 KVM 所需的软件包。首先需要部署基于光盘镜像的本地 YUM 源，然后执行以下命令安装相关软件：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装GNOME桌面环境")]),t._v("\nyum groupinstall "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GNOME Desktop"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装KVM模块")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" qemu-kvm\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装KVM调试工具（可选）")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" qemu-kvm-tools\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装构建虚拟机的命令行工具")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" virt-install\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装qemu组件，用于创建磁盘和启动虚拟机")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" qemu-img\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装网络支持工具")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" bridge-utils\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装虚拟机管理工具")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" libvirt\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装图形界面管理虚拟机工具")]),t._v("\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" virt-manager\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br"),s("span",{staticClass:"line-number"},[t._v("10")]),s("br"),s("span",{staticClass:"line-number"},[t._v("11")]),s("br"),s("span",{staticClass:"line-number"},[t._v("12")]),s("br"),s("span",{staticClass:"line-number"},[t._v("13")]),s("br"),s("span",{staticClass:"line-number"},[t._v("14")]),s("br"),s("span",{staticClass:"line-number"},[t._v("15")]),s("br"),s("span",{staticClass:"line-number"},[t._v("16")]),s("br")])]),s("p",[t._v("安装完成后，需要将系统的默认运行目标更改为图形化界面，否则重启时可能会报错：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-sf")]),t._v(" /lib/systemd/system/graphical.target /etc/systemd/system/default.target\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h4",{attrs:{id:"_4-1-2-验cpu-虚拟化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-验cpu-虚拟化"}},[t._v("#")]),t._v(" 4.1.2 验CPU 虚拟化")]),t._v(" "),s("p",[t._v("重启系统后，需要验证 CPU 是否支持虚拟化技术，使用以下命令检查 KVM 模块是否正确安装：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("lsmod "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" kvm\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("如果输出结果中包含"),s("code",[t._v("kvm_intel")]),t._v("或"),s("code",[t._v("kvm_amd")]),t._v("，则说明 KVM 模块已成功加载")]),t._v(" "),s("h4",{attrs:{id:"_4-1-3-开启-libvirtd-服务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-3-开启-libvirtd-服务"}},[t._v("#")]),t._v(" 4.1.3 开启 libvirtd 服务")]),t._v(" "),s("p",[t._v("安装完成后，需要启动 libvirtd 服务以提供相关支持：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 启动libvirtd服务")]),t._v("\nsystemctl start libvirtd\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置libvirtd服务开机自启")]),t._v("\nsystemctl "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" libvirtd\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("h3",{attrs:{id:"_4-2-设置-kvm43网络-桥接模式"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-设置-kvm43网络-桥接模式"}},[t._v("#")]),t._v(" 4.2 设置 KVM43网络（桥接模式）")]),t._v(" "),s("h4",{attrs:{id:"_4-2-1-网络模式介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-1-网络模式介绍"}},[t._v("#")]),t._v(" 4.2.1 网络模式介绍")]),t._v(" "),s("p",[t._v("在 libvirt 中运行 KVM 网络有两种模式：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("NAT 模式")]),t._v("：默认网络模式，数据包通过 NAT 方式经主机网卡接口传送，虚拟机可以访问外网，但外部主机无法访问虚拟机内部网络")]),t._v(" "),s("li",[s("strong",[t._v("桥接模式")]),t._v("：允许虚拟机像独立主机一样拥有网络，外部机器可以直接访问虚拟机内部，但需要网卡支持（一般有线网卡都支持）")])]),t._v(" "),s("p",[t._v("这里，以桥接模式为例进行配置，宿主机 IP 地址为 192.168.10.1。首先编辑物理网卡配置文件：")]),t._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/sysconfig/network-scripts/ifcfg-ens33\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("添加以下内容")]),t._v(" "),s("h2",{attrs:{id:"查看完整文章"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看完整文章"}},[t._v("#")]),t._v(" 查看完整文章")]),t._v(" "),s("p",[t._v("加入"),s("a",{attrs:{href:"https://public.zsxq.com/groups/48848484411888.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("冰河技术"),s("OutboundLink")],1),t._v("知识星球，解锁完整技术文章、小册、视频与完整代码")])])}),[],!1,null,null,null);s.default=r.exports}}]);